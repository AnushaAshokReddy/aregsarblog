# Configure Laravel Cache To Use Redis

April 14, 2020 by [Areg Sarkissian](https://aregsar.com/about)

> Note: These are installation instructions for Laravel 7. The post will get updated as needed newer versions of Laravel 

In this article I will show you how to convert the Laravel Cache configuration to use Redis.

By default Laravel uses the file driver to cache data. This will not be performant for high traffic sites.

## The Laravel Cache facade/provider configuration

The Laravel cache configuration file `config/cache.php` has a list of stores as defined by the `stores` setting:

```php
 'default' => env('CACHE_DRIVER', 'file'),
 'stores' => [
        'redis' => [
            'driver' => 'redis',
            'connection' => 'cache',
        ],
        'file' => [
            'driver' => 'file',
            'path' => storage_path('framework/cache/data'),
        ],

    ],
```

The configuration file also has default cache store setting defined by the  `'default'` setting in the `config/cache.php` file:

```php
 'default' => env('CACHE_DRIVER', 'file'),
```

> Note: the `CACHE_DRIVER` environment variable used to set the cache `default` is a misnomer because it indicates that it is the setting for a cache `driver` where in actuality it is setting the cache to a `store` that is one of the stores specified in the `stores` setting. The actual cache driver will be the driver specified within the selected store. I like to change the `CACHE_DRIVER` to `CACHE_STORE` to accurately represent the `default` cache store setting.

All stores defined in `config/cache.php` have a `driver` setting.

The `file` store has a driver setting of `file` and a path setting for the file used to cache data.

The `'redis'` store has a `driver` setting set to `redis` which sets the driver to use the `redis` driver specified in `config/database.php`

The redis store also has a `connection` setting that is set to the `connection` setting of the `'redis'` driver from `config/database.php`, where the `'redis'` driver from `config/database.php` is set to the `'redis'` store `'driver'` in `config/cache.php`.

In other words the `redis` store setting in `config/cache.php` has a `driver` setting set to `redis` and a `connection` setting set to the `cache` connection, where the `cache` connection is one of the out of the box connections generated by Laravel for the the `redis` driver specified in `config/database.php`.

The annotated snippets from  both `config/cache.php` and `config/database.php` shown below should clarify what I have jus described above:

```php
// config/cache.php
 'default' => env('CACHE_STORE', 'redis'),
 'stores' => [
        // This is the redis store driver
        'redis' => [
            // uses the redis driver defined in config/database.php
            'driver' => 'redis',
            // uses the 'cache' named connection of the 'redis' driver from config/database.php
            'connection' => 'cache',
        ]
    ],
```

```php
// config/database.php
// This is the 'redis' driver
'redis' => [
        // This is the redis driver connection named 'cache'
        'cache' => [
            'url' => env('REDIS_URL'),
            'host' => env('REDIS_HOST', '127.0.0.1'),
            'password' => env('REDIS_PASSWORD', null),
            'port' => env('REDIS_PORT', '6379'),
            'database' => env('REDIS_CACHE_DB', '1'),
        ],
    ],
```

## Changing the default Laravel facade/provider cache driver to use Redis

To let the Laravel cache facade\provider use Redis by default we need to change the value of the `default` setting in `config/cache.php` to use the `'redis'` cache store show below:

```php
 'default' => env('CACHE_DRIVER', 'file'),
```

We can do so by changing the out of the box `CACHE_DRIVER=file` setting in the `.env` file tp `CACHE_DRIVER=redis`

If we know that we will always be using redis then we can even remove the `CACHE_DRIVER=redis` setting and just the change the default second parameter to env() function to `redis`:

```php
 'default' => env('CACHE_DRIVER', 'redis'),
```

Alternatively if we always use Redis as the cache, we can remove the environment variable and hard code the setting in `config/cache.php`:

```php
 'default' => 'redis',
```

## Using the default Laravel cache store

The snippet below uses the default cache store specified in `config/cache.php`:

```php
$value = Cache::get('foo');
```

## Using an explicit cache store for Laravel Cache

we can explicitly select a store from stores specified in `config/cache.php` to override the default cache configuration when using the cache provider or facade.

The snippet below explicitly uses a the `file` store specified in `config/cache.php` even though the default cache store is set to `redis` in `config/cache.php`:

```php
$value = Cache::store('file')->get('bar');
```

## Adding and using additional cache stores

We can additional cache `redis` stores in `config/cache.php` that are configured to use other `redis` driver connections in `config/database.php`.

Below is an example of adding a `redis2` store to `config/cache.php` that references a `cache2` redis connection added to the `redis` driver in `config/database.php`:

```php
// config/cache.php
 'stores' => [
        'redis' => [
            // uses the redis driver defined in config/database.php
            'driver' => 'redis',
            // uses the 'cache' configuration of the 'redis' driver in config/database.php
            'connection' => 'cache',
        ],
        'redis2' => [
            // uses the redis driver defined in config/database.php
            'driver' => 'redis',
            // uses the 'cache' configuration of the 'redis' driver in config/database.php
            'connection' => 'cache2',
        ]
    ],
```

```php
// config/database.php
'redis' => [
        'cache' => [
            'url' => env('REDIS_URL'),
            'host' => env('REDIS_HOST', '127.0.0.1'),
            'password' => env('REDIS_PASSWORD', null),
            'port' => env('REDIS_PORT', '6379'),
            'database' => env('REDIS_CACHE_DB', '1'),
        ],
        'cache2' => [
            'url' => env('REDIS_URL'),
            'host' => env('REDIS_HOST', '127.0.0.1'),
            'password' => env('REDIS_PASSWORD', null),
            'port' => env('REDIS_PORT', '6379'),
            'database' => env('REDIS_CACHE_DB', '1'),
        ],

    ],
```

Given the above settings we can explicitly use the new `redis2` store like so:

```php
$value = Cache::store('redis2')->get('bar');
```

## Changing the default redis store

We could also change the `default` setting in `config/cache.php` to use a different cache store instead of the out of the box configured `redis` store.

For instance we can use the `redis2` cache store we added to `config/database.php` above and set it to the `default` setting in `config/cache.php` instead of using the out of the box `redis` store in `config/database.php`.

```php
 'default' => 'redis2',
```

Now the following code will use `redis2` store as the default store:

```php
$value = Cache::get('foo');
```
