# My VSCode PHP Development Setup

September 17, 2020 by [Areg Sarkissian](https://aregsar.com/about)

[My VSCode PHP Development Setup](https://aregsar.com/blog/2020/my-vscode-php-development-setup)

In this post I will share the VSCode php development extensions and keybindings that I use.

My setup is based on resources listed at the end of this article.

I am consolidating and adapting the information from those resources for my own setup for future reference and for anyone who would like a quick setup guide.

## PHP Extensions

First thing to do is install the following VSCode extensions:

- `PHP Intelephense` extension by `Ben Mewburn`

- `PHP Debug` extension by `Felix Becker`

- `Better PHPUnit` extension by `calebporzio`

## Configuring VSCode with XDebug for debugging

Follow the following four steps to configure XDebug.

### Step 1

First we need to install the PHP XDebug extension:

```bash
# force install the extension
pecl install --force xdebug
# check that the xdebug shows in the list of PHP extensions
php -m
```

### Step 2

After that locate your php.ini file:

```bash
php --ini
```

This print the location `/usr/local/etc/php/7.4/php.ini` on my MacBook.

Opening up the file:

```bash
cat /usr/local/etc/php/7.4/php.ini
```

I see the extension shown at the top of the file:

```ini
zend_extension="xdebug.so"
```

According the to the XDebug documentation we need to include the full path of the PHP extensions directory.
Run `pecl config-get ext_dir` to get the full path of the PHP extensions directory.
On my Mac the output is: `/usr/local/lib/php/pecl/20190902`

We also need to add the setting to enable remote debugging and set the remote port number.
On my machine I run Laravel Valet which runs php-fpm on port 9000 so I set the XDebug remote port value to 9001.
These additions are shown below:

```ini
zend_extension="/usr/local/lib/php/pecl/20190902/xdebug.so"
xdebug.remote_enable=1
xdebug.remote_port=9001
```

> You can opt to add separate config file at `/usr/local/etc/php/7.4/conf.d/ext-xdebug.ini` instead and include those
> lines there. See resource articles for instructions.

### Step 3

Next open your shell configuration file which, for me is the `.zshrc` file, and add the following:

```ini
export XDEBUG_CONFIG="idekey=VSCODE"
```

### Step 4

Open VSCode from within your project directory.

```bash
cd myproject
code .
```

Open the debug panel by pressing `cmd+sh+d` keyboard shortcut.

Click on the `show` link where it says `show all automatic debug configurations`.
Click on add configuration and select `PHP` from the drop down.

This will add `launch.json` debugging configuration to your project with settings for XDebug listening on port 9000.
As mentioned before need to change the XDebug port value to 9001 since to avoid conflict with php-fpm running on port 9000.

The `.vscode/launch.json` configuration file generated by VSCode is shown here with the port number changed:

```json
{
  // Use IntelliSense to learn about possible attributes.
  // Hover to view descriptions of existing attributes.
  // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Listen for XDebug",
      "type": "php",
      "request": "launch",
      "port": 9001
    },
    {
      "name": "Launch currently open script",
      "type": "php",
      "request": "launch",
      "program": "${file}",
      "cwd": "${fileDirname}",
      "port": 9001
    }
  ]
}
```

## Running a XDebug debugging session from VSCode

Now you are ready to add breakpoints to your project files and debug your application.

Do the following steps:

1-Run

```bash
php artisan serve
```

2-Open the VSCode debug panel and Click the "listen for XDebug" play button.
This launches the debugger toolbar and starts the debugger.
You can click the stop button to stop a session.
You can use the continue and step buttons to continue execution after hitting a breakpoint.

3- navigate to `http://localhost:8000` in your browser.
You should see your application in the browser.

4-If you inspect the page you should see a `XDEBUG_SESSION=VSCODE` cookie written by the response.
If you don't see the cookie try navigating to `http://localhost:8000?XDEBUG_SESSION_START=VSCODE` instead and make sure the response contains the cookie.

To test breakpoints, set a break point on the line that returns the welcome view in `routes/web.php` file of a new Laravel project.

```php
Route::get('/', function () {
    return view('welcome'); //set breakpoint on this line
});
```

Now Refresh the page in the web browser and you should hit the breakpoint where you
can inspect variables and the stack trace. Click the continue button in the debugger toolbar to continue and return the response.

If the breakpoint doesn't get hit make sure the the response contains
the `XDEBUG_SESSION=VSCODE` cookie as indicated before.

## Debugging using Valet

If you have Valet running then you don't need to run `php artisan serve`. Just follow the remaining steps of the previous section except navigate to `http://yourappname.test?XDEBUG_SESSION_START=VSCODE` instead.

> Without the XDEBUG_SESSION_START parameter the XDEBUG_SESSION cookie is not written to the response, when using Valet to serve our app. Once the cookie is written though, we don't need to add the XDEBUG_SESSION_START parameter to the browser requests anymore.

## XDebug Issue with Laravel Cookie Encryption

## Configuring vscode for phpunit testing

To run your phpunit tests from within vscode, open the terminal by selecting the `ctrl+backtick` keyboard shortcut then type in `phpunit` in the terminal window to execute the tests.

If you have the `Better PHPUnit` vscode extension installed, you can click in the test class or test methods in your phpunit test files and execute specific tests by typing `phpunit` in the command panel.
The command panel is accessible via the `cmd+sh+p` keyboard shortcut.

Alternatively you can use the `Better PHPUnit` extensions keyboard shortcuts to run tests.
I have remapped those shortcuts to the shortcuts described in the laracasts video mentioned above.
To do that you can open keyboard shortcuts UI from command pallete then
type `better phpunit` in the search box to bringup all the shortcuts for that extension.
I changed the `run` shortcut to `cmd+t` and the `run previous` to `cmd+sh+t`.

With these shortcuts, you can click in a test class or test method and select `cmd+t` to run the corresponding test.
If you navigate cursor to another location you can alway select `cmd+sh+t` to rerun the last test that you ran without having to go back and click in that class or method.

## Resources

https://tighten.co/blog/configure-vscode-to-debug-phpunit-tests-with-xdebug/

https://laracasts.com/series/visual-studio-code-for-php-developers

https://cleody.com/setup-xdebug-in-laravel-valet-with-php-7-3-and-phpstorm/
